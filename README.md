# WCPP: WASA Common Packet Protocol

コマンドおよびテレメトリに用いる，統一されたデータシリアライズフォーマット．

# 目的
電装で共通に用いる，コマンドやテレメトリのフォーマットを規定する．
バイナリ形式でデータを表現することで，テキストフォーマットと比べてデータサイズを削減する．

パケットの内容についてはスキーマレス，すなわちパケットの定義を知らなくても
ある程度デコード可能とする．これにより各所でスキーマ定義を共有する手間を削減し，
迅速な開発を可能にする．

CANやUARTを用いた有線通信，LoRa等による無線通信，SDカードへの記録，
テレメトリ・ログ可視化ツール等に用いる．
バスによって接続された同一ユニット内におけるのローカルな情報のやり取りに加えて，
無線等により連携した複数の独立したユニット間の通信にも用いる．

# 用語

用語を定義する．

## ユニット

バスで接続され，単独で動作する単位．例：ロケット電装，CanSat電装，地上局

実体ごとに8bitの固有のIDを有する．同じ種類のユニットであっても，IDが重複してはならない．

特殊なユニットIDとして，自身の属するユニットを表す`0x00`（local）と，
全てのユニットを表す`0xFF` (broadcast)，
管制・運用ステーションを表す`0xFE`（control）がある．

## コンポーネント

ユニットを構成する，意味のある一つの機能単位．例：電源管理，姿勢決定，モーター駆動

ユニット内で重複しない8bitのIDを持つ．ユニット内に同じ種類のコンポーネントが複数ある場合でも，
IDは重複してはならない．
ハードウェアに結びついていない，純粋にソフトウェア的な機能を提供するコンポーネントも存在してよい．

特殊なコンポーネントとして，ユニット内に一つのみ存在するメインコンポーネント`0x00`(main)がある．

# パケットフォーマット

パケットを情報の単位とする．パケットには，ユニット内でやり取りするローカルパケットと，
ユニットをまたいでやり取りするリモートパケットがある．

パケットはヘッダ部と，0以上のエントリからなる．
エントリの順序は保持されなければならない．パケットの最大サイズは 256 byte である．

| 項目                | サイズ     |
|---------------------|------------|
| ヘッダ              | 4 or 7 byte     |
| エントリ*N          | 0~251 byte |
| チェックサム（CRC8) | 1 byte     |

## ヘッダ

### ローカルパケットヘッダ
| 項目 ｜ サイズ     | 備考   |                                                            |
|------------------|--------|------------------------------------------------------------|
| サイズ           | 1 byte | パケットのバイト数．このbyteの分を含む                 |
| パケットID       | 1 byte | 下位7bitがID．上位1bitが 0: コマンド，1: テレメトリ |
| コンポーネントID | 1 byte | コマンドなら送信先，テレメトリなら送信元                   |
| 0x00             | 1 byte | （送信元ユニットID）                                                |

### リモートパケットヘッダ
| 項目 ｜ サイズ     | 備考   |                                                            |
|------------------|--------|------------------------------------------------------------|
| サイズ           | 1 byte | パケットのバイト数．このbyteの分を含む                 |
| パケットID       | 1 byte | 下位7bitがID．上位1bitが 0: コマンド，1: テレメトリ |
| コンポーネントID | 1 byte | コマンドなら送信先，テレメトリなら送信元                   |
| 送信元ユニットID | 1 byte |                                                            |
| 送信先ユニットID | 1 byte |                                                            |
| シーケンス番号   | 2 byte | 送信元ユニット・コンポーネント毎にインクリメントされる番号．重複検知に用いる       |

## エントリ

エントリはデータの種類などの情報を表すタイプ部と，データ自体であるペイロード部からなる．
一つのパケットの中に同じタイプのエントリが含まれていてもよく，
その場合は配列として解釈する．

| 項目       | サイズ |
| ----       | ------ |
| タイプ     | 2 byte |
| ペイロード | 0~ byte |

### タイプ

エントリ名は大文字・小文字を区別しない英字2文字分でエントリの内容を示し，
各文字には大文字のASCIIコードから64を引いた5bitの値が入る．
データ型は型の区別やペイロードの長さの情報を与える．

| バイト | パターン | 項目 |
| --- | --- | --- |
| 0 | xxx----- | データ型ビットパターン 下位3bit |
| 0 | ---aaaaa | エントリ名 1文字目 |
| 1 | yyy----- | データ型ビットパターン 上位3bit |
| 1 | ---bbbbb | エントリ名 2文字目 |

### データ型

区別される型はnull, 整数，浮動小数点数，バイト列，パケット，部分構造体である．
Bool型やEnum型は符号なし整数として表現される．
浮動小数点数は16bit, 32bit, 64bit精度のいずれかを使用できる．

| ビットパターン | 型 | ペイロードのバイト数 | 備考 |
| ----   | ------ | ------  | ------ |
| 000000 | null | 0 | 値が存在しないことを表す |
| 000001 | struct | 1\~ | 入れ子の構造体．1バイト目がバイト数を表し，その後エントリが続く |
| 000010 | packet | 5\~ | 入れ子のパケット．ヘッダーの後エントリが続く |
| 000011 | bytes | 1\~ | 任意長のバイト列．1バイト目が長さを表す |
| 000100 | float | 0 | 浮動小数点数の 0.0 |
| 000101 | float16 | 2 | 半精度浮動小数点数（10進で約3桁の精度）|
| 000110 | float32 | 4 | 単精度浮動小数点数（10進で約6桁の精度）|
| 000111 | float64 | 8 | 倍精度浮動小数点数（10進で約16桁の精度）|
| 001xxx | bytes | xxx (0\~7) | 7 byte までの長さのバイト列|
| 01sxxx | int | xxx+1 (1\~8) | 可変長の整数．xxx: バイト数，s: 符号（0: +, 1: -） |
| 1xxxxx | int | 0 | xxxxx: 5 bit までの符号なし整数 |


同じ値を表す表現のうち，最も短くなる表現を用いる．

### ペイロード

ペイロードはリトルエンディアンのバイト列である．
ペイロードの解釈は前述のデータ型ビットパターンに従って行う．

# バス

上述のパケットプロトコルを用いたバスについて規定する．

## 共通規定

### ノードID

### ハートビート

## CAN バス

### 拡張ID (29 bit)

| 項目             | サイズ |
| ----            | ------ |
| パケットID      | 8 bit |
| コンポーネントID | 8 bit |
| 送信元ユニットID | 8 bit  |
| フレーム番号     | 5 bit  |


## UART バス


# 開発

## テスト

### C++ (Google Test)

```
mkdir cpp/build
cd cpp/build
cmake ..
make
./test_packet --gtest_break_on_failure --gtest_repeat=1000
```

### Python (pytest)

```
pip install -r requiements.txt
pytest -s
```

